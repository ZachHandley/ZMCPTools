{% extends "base.html" %}

{% block title %}Agents - ClaudeMcpTools{% endblock %}

{% block page_actions %}
<button class="btn btn-primary" onclick="showSpawnAgentModal()">
    <span class="btn-icon">ðŸ¤–</span>
    Spawn Agent
</button>
<button class="btn btn-secondary" onclick="window.location.reload()">
    <span class="btn-icon">ðŸ”„</span>
    Refresh
</button>
{% endblock %}

{% block content %}
<div class="agents-container">
    {% if agents %}
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Active Agents ({{ agents|length }})</h3>
        </div>
        <div class="card-content">
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Agent ID</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Repository</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for agent in agents %}
                        <tr>
                            <td>
                                <code>{{ agent.agent_id[:8] }}...</code>
                            </td>
                            <td>
                                <span class="agent-type">{{ agent.agent_type or 'Unknown' }}</span>
                            </td>
                            <td>
                                <span class="status-badge status-{{ agent.status or 'unknown' }}">
                                    {{ agent.status or 'Unknown' }}
                                </span>
                            </td>
                            <td>
                                <span class="repository-path" title="{{ agent.repository_path }}">
                                    {% if agent.repository_path %}
                                        {{ agent.repository_path.split('/')[-1] }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </span>
                            </td>
                            <td>
                                <span class="created-time">
                                    {% if agent.created_at %}
                                        {{ agent.created_at }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </span>
                            </td>
                            <td>
                                <div class="agent-actions">
                                    <button class="btn btn-sm btn-secondary" onclick="showAgentDetails('{{ agent.agent_id }}')">
                                        Details
                                    </button>
                                    {% if agent.status == 'active' %}
                                    <button class="btn btn-sm btn-danger" onclick="terminateAgent('{{ agent.agent_id }}')">
                                        Terminate
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% else %}
    <div class="card">
        <div class="card-content">
            <div class="empty-state">
                <h3>No Active Agents</h3>
                <p>No agents are currently running. Spawn a new agent to get started.</p>
                <button class="btn btn-primary" onclick="showSpawnAgentModal()">
                    <span class="btn-icon">ðŸ¤–</span>
                    Spawn Your First Agent
                </button>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Agent Statistics -->
    <div class="agents-stats">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Agent Statistics</h3>
            </div>
            <div class="card-content">
                <div class="stats-grid">
                    <div class="stat">
                        <div class="stat-value">{{ agents|length }}</div>
                        <div class="stat-label">Total Agents</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">
                            {{ agents|selectattr("status", "equalto", "active")|list|length }}
                        </div>
                        <div class="stat-label">Active</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">
                            {{ agents|selectattr("status", "equalto", "inactive")|list|length }}
                        </div>
                        <div class="stat-label">Inactive</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Agent Types -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Agent Types</h3>
            </div>
            <div class="card-content">
                <div class="agent-types">
                    {% set agent_types = {} %}
                    {% for agent in agents %}
                        {% set agent_type = agent.agent_type or 'unknown' %}
                        {% if agent_types.update({agent_type: agent_types.get(agent_type, 0) + 1}) %}{% endif %}
                    {% endfor %}
                    
                    {% if agent_types %}
                        {% for type, count in agent_types.items() %}
                        <div class="type-item">
                            <span class="type-name">{{ type.title() }}</span>
                            <span class="type-count">{{ count }}</span>
                        </div>
                        {% endfor %}
                    {% else %}
                    <div class="empty-state">
                        <p>No agent type data available</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.agents-container {
    display: grid;
    gap: 2rem;
}

.agents-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
}

.table-container {
    overflow-x: auto;
}

.btn-sm {
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
}

.agent-actions {
    display: flex;
    gap: 0.5rem;
}

.agent-type {
    background-color: var(--bg-secondary);
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 500;
}

.repository-path {
    font-family: monospace;
    background-color: var(--bg-secondary);
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.875rem;
}

.created-time {
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.type-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--border-color);
}

.type-item:last-child {
    border-bottom: none;
}

.type-name {
    font-weight: 500;
}

.type-count {
    background-color: var(--accent-color);
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 500;
}

.status-active {
    background-color: var(--success-color);
    color: white;
}

.status-inactive {
    background-color: var(--text-secondary);
    color: white;
}

.status-failed {
    background-color: var(--error-color);
    color: white;
}
</style>

<script>
function showSpawnAgentModal() {
    showModal('Spawn New Agent', `
        <form id="spawn-agent-form" onsubmit="spawnAgent(event)">
            <div class="form-group">
                <label for="agent-type">Agent Type</label>
                <select id="agent-type" name="agent_type" required>
                    <option value="">Select agent type...</option>
                    <option value="implementer">Implementer - Code implementation and development</option>
                    <option value="tester">Tester - Test creation and execution</option>
                    <option value="reviewer">Reviewer - Code review and quality assurance</option>
                    <option value="debugger">Debugger - Bug investigation and fixing</option>
                    <option value="documenter">Documenter - Documentation creation and updates</option>
                    <option value="architect">Architect - System design and architecture</option>
                </select>
            </div>
            <div class="form-group">
                <label for="task-description">Task Description</label>
                <textarea id="task-description" name="task_description" required placeholder="Describe what this agent should work on..." rows="4"></textarea>
            </div>
            <div class="form-group">
                <label for="repository-path">Repository Path</label>
                <input type="text" id="repository-path" name="repository_path" required placeholder="/path/to/project" value="/home/zach/github/ClaudeMcpTools">
            </div>
        </form>
    `, `
        <button class="btn btn-secondary" onclick="hideModal()">Cancel</button>
        <button class="btn btn-primary" onclick="document.getElementById('spawn-agent-form').requestSubmit()">Spawn Agent</button>
    `);
}

async function spawnAgent(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    
    if (!utils.validateForm(event.target)) {
        showNotification('Please fill in all required fields', 'error');
        return;
    }
    
    try {
        showNotification('Spawning agent...', 'info');
        const response = await fetch('/api/agents/spawn', {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            const result = await response.json();
            hideModal();
            showNotification('Agent spawned successfully', 'success');
            setTimeout(() => window.location.reload(), 1000);
        } else {
            const error = await response.text();
            showNotification('Failed to spawn agent: ' + error, 'error');
        }
    } catch (error) {
        showNotification('Error spawning agent: ' + error.message, 'error');
    }
}

async function terminateAgent(agentId) {
    if (!confirm('Are you sure you want to terminate this agent? This action cannot be undone.')) {
        return;
    }
    
    try {
        showNotification('Terminating agent...', 'info');
        const response = await fetch(`/api/agents/${agentId}/terminate`, {
            method: 'POST'
        });
        
        if (response.ok) {
            showNotification('Agent terminated successfully', 'success');
            setTimeout(() => window.location.reload(), 1000);
        } else {
            const error = await response.text();
            showNotification('Failed to terminate agent: ' + error, 'error');
        }
    } catch (error) {
        showNotification('Error terminating agent: ' + error.message, 'error');
    }
}

function showAgentDetails(agentId) {
    // This would show detailed information about the agent
    showModal('Agent Details', `
        <div class="agent-details">
            <p><strong>Agent ID:</strong> ${agentId}</p>
            <p>Detailed agent information would be displayed here, including:</p>
            <ul>
                <li>Current task status</li>
                <li>Capabilities and configuration</li>
                <li>Communication history</li>
                <li>Performance metrics</li>
                <li>Recent activities</li>
            </ul>
            <p><em>Full agent details feature coming soon...</em></p>
        </div>
    `, `
        <button class="btn btn-secondary" onclick="hideModal()">Close</button>
    `);
}
</script>
{% endblock %}