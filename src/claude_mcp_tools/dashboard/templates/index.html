{% extends "base.html" %}

{% block title %}Dashboard - ClaudeMcpTools{% endblock %}

{% block page_actions %}
<button class="btn btn-primary" onclick="refreshDashboard()">
    <span class="btn-icon">ðŸ”„</span>
    Refresh
</button>
{% endblock %}

{% block content %}
<div class="dashboard-grid">
    <!-- System Overview -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">System Overview</h3>
            <span class="status-badge status-{{ system_status.system_health or 'unknown' }}">
                {{ system_status.system_health or 'Unknown' }}
            </span>
        </div>
        <div class="card-content">
            <div class="stats-grid">
                <div class="stat">
                    <div class="stat-value">{{ system_status.agents.active or 0 }}</div>
                    <div class="stat-label">Active Agents</div>
                </div>
                <div class="stat">
                    <div class="stat-value">{{ system_status.tasks.pending or 0 }}</div>
                    <div class="stat-label">Pending Tasks</div>
                </div>
                <div class="stat">
                    <div class="stat-value">{{ "%.1f"|format(system_status.storage.total_size_mb or 0) }} MB</div>
                    <div class="stat-label">Storage Used</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Storage Breakdown -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Storage Breakdown</h3>
        </div>
        <div class="card-content">
            {% if system_status.storage %}
            <div class="storage-item">
                <div class="storage-label">Database</div>
                <div class="storage-bar">
                    <div class="storage-fill" style="width: {{ (system_status.storage.breakdown.database_mb / (system_status.storage.total_size_mb or 1) * 100) | round(1) }}%"></div>
                </div>
                <div class="storage-value">{{ "%.1f"|format(system_status.storage.breakdown.database_mb or 0) }} MB</div>
            </div>
            <div class="storage-item">
                <div class="storage-label">Documentation</div>
                <div class="storage-bar">
                    <div class="storage-fill" style="width: {{ (system_status.storage.breakdown.documentation_mb / (system_status.storage.total_size_mb or 1) * 100) | round(1) }}%"></div>
                </div>
                <div class="storage-value">{{ "%.1f"|format(system_status.storage.breakdown.documentation_mb or 0) }} MB</div>
            </div>
            <div class="storage-item">
                <div class="storage-label">Cache</div>
                <div class="storage-bar">
                    <div class="storage-fill" style="width: {{ (system_status.storage.breakdown.cache_mb / (system_status.storage.total_size_mb or 1) * 100) | round(1) }}%"></div>
                </div>
                <div class="storage-value">{{ "%.1f"|format(system_status.storage.breakdown.cache_mb or 0) }} MB</div>
            </div>
            {% else %}
            <div class="empty-state">
                <p>Storage information unavailable</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Quick Actions</h3>
        </div>
        <div class="card-content">
            <div class="quick-actions">
                <button class="action-btn" onclick="showSpawnAgentModal()">
                    <span class="action-icon">ðŸ¤–</span>
                    <span class="action-text">Spawn Agent</span>
                </button>
                <button class="action-btn" onclick="window.location.href='/cleanup'">
                    <span class="action-icon">ðŸ§¹</span>
                    <span class="action-text">Run Cleanup</span>
                </button>
                <button class="action-btn" onclick="showAddDocumentationModal()">
                    <span class="action-icon">ðŸ“š</span>
                    <span class="action-text">Add Documentation</span>
                </button>
                <button class="action-btn" onclick="vacuumDatabase()">
                    <span class="action-icon">ðŸ”§</span>
                    <span class="action-text">Optimize Database</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="card span-2">
        <div class="card-header">
            <h3 class="card-title">Recent Activity</h3>
        </div>
        <div class="card-content">
            <div class="activity-list" id="recent-activity">
                <div class="activity-item">
                    <div class="activity-icon">ðŸ“Š</div>
                    <div class="activity-content">
                        <div class="activity-text">Dashboard loaded</div>
                        <div class="activity-time">Just now</div>
                    </div>
                </div>
                <div class="empty-state">
                    <p>Recent activity will appear here</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Database Records -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Database Records</h3>
        </div>
        <div class="card-content">
            {% if system_status.storage and system_status.storage.record_counts %}
            <div class="record-counts">
                <div class="record-item">
                    <span class="record-label">Agents:</span>
                    <span class="record-value">{{ system_status.storage.record_counts.agents or 0 }}</span>
                </div>
                <div class="record-item">
                    <span class="record-label">Tasks:</span>
                    <span class="record-value">{{ system_status.storage.record_counts.tasks or 0 }}</span>
                </div>
                <div class="record-item">
                    <span class="record-label">Messages:</span>
                    <span class="record-value">{{ system_status.storage.record_counts.messages or 0 }}</span>
                </div>
                <div class="record-item">
                    <span class="record-label">Documentation:</span>
                    <span class="record-value">{{ system_status.storage.record_counts.documentation or 0 }}</span>
                </div>
                <div class="record-item">
                    <span class="record-label">Errors:</span>
                    <span class="record-value">{{ system_status.storage.record_counts.errors or 0 }}</span>
                </div>
            </div>
            {% else %}
            <div class="empty-state">
                <p>Database information unavailable</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Dashboard-specific JavaScript
function refreshDashboard() {
    window.location.reload();
}

function showSpawnAgentModal() {
    showModal('Spawn New Agent', `
        <form id="spawn-agent-form" onsubmit="spawnAgent(event)">
            <div class="form-group">
                <label for="agent-type">Agent Type</label>
                <select id="agent-type" name="agent_type" required>
                    <option value="implementer">Implementer</option>
                    <option value="tester">Tester</option>
                    <option value="reviewer">Reviewer</option>
                    <option value="debugger">Debugger</option>
                    <option value="documenter">Documenter</option>
                    <option value="architect">Architect</option>
                </select>
            </div>
            <div class="form-group">
                <label for="task-description">Task Description</label>
                <textarea id="task-description" name="task_description" required placeholder="Describe what this agent should work on..."></textarea>
            </div>
            <div class="form-group">
                <label for="repository-path">Repository Path</label>
                <input type="text" id="repository-path" name="repository_path" required placeholder="/path/to/project" value="/home/zach/github/ClaudeMcpTools">
            </div>
        </form>
    `, `
        <button class="btn btn-secondary" onclick="hideModal()">Cancel</button>
        <button class="btn btn-primary" onclick="document.getElementById('spawn-agent-form').requestSubmit()">Spawn Agent</button>
    `);
}

function showAddDocumentationModal() {
    showModal('Add Documentation Source', `
        <form id="add-docs-form" onsubmit="addDocumentation(event)">
            <div class="form-group">
                <label for="docs-url">Documentation URL</label>
                <input type="url" id="docs-url" name="url" required placeholder="https://docs.example.com">
            </div>
            <div class="form-group">
                <label for="docs-name">Source Name</label>
                <input type="text" id="docs-name" name="name" required placeholder="Example Documentation">
            </div>
            <div class="form-group">
                <label for="crawl-depth">Crawl Depth</label>
                <input type="number" id="crawl-depth" name="crawl_depth" value="3" min="1" max="10">
            </div>
        </form>
    `, `
        <button class="btn btn-secondary" onclick="hideModal()">Cancel</button>
        <button class="btn btn-primary" onclick="document.getElementById('add-docs-form').requestSubmit()">Add Source</button>
    `);
}

async function spawnAgent(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    
    try {
        const response = await fetch('/api/agents/spawn', {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            hideModal();
            showNotification('Agent spawned successfully', 'success');
            setTimeout(() => window.location.reload(), 1000);
        } else {
            const error = await response.text();
            showNotification('Failed to spawn agent: ' + error, 'error');
        }
    } catch (error) {
        showNotification('Error spawning agent: ' + error.message, 'error');
    }
}

async function addDocumentation(event) {
    event.preventDefault();
    // Documentation addition would be implemented here
    hideModal();
    showNotification('Documentation source addition not yet implemented', 'info');
}

async function vacuumDatabase() {
    if (!confirm('This will optimize the database and may take a few moments. Continue?')) {
        return;
    }
    
    try {
        const response = await fetch('/api/cleanup/vacuum', {
            method: 'POST'
        });
        
        if (response.ok) {
            const result = await response.json();
            showNotification(`Database optimized. Saved ${result.space_saved_mb || 0} MB`, 'success');
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showNotification('Failed to optimize database', 'error');
        }
    } catch (error) {
        showNotification('Error optimizing database: ' + error.message, 'error');
    }
}
</script>
{% endblock %}